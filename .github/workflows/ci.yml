name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    name: Build & Tests
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=5s
          --health-timeout=2s
          --health-retries=10
    env:
      DATABASE_URL: mysql://root:root@127.0.0.1:3306/test_db
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Wait for MySQL to be ready
        run: |
          for i in $(seq 1 30); do
            if mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1" >/dev/null 2>&1; then
              echo "MySQL is ready"; break
            fi
            echo "Waiting for MySQL..."; sleep 1
          done

      - name: Install MySQL client
        run: |
          sudo apt-get update && sudo apt-get install -y default-mysql-client

      - name: Create test DB schema
        run: |
          cat > schema.sql <<'SQL'
          CREATE TABLE IF NOT EXISTS users (
            id BIGINT PRIMARY KEY AUTO_INCREMENT,
            name VARCHAR(255),
            email VARCHAR(255) UNIQUE,
            password VARCHAR(255),
            address TEXT NULL,
            role VARCHAR(50) DEFAULT 'user'
          );

          CREATE TABLE IF NOT EXISTS kategori (
            id INT PRIMARY KEY AUTO_INCREMENT,
            name VARCHAR(255) NOT NULL
          );

          CREATE TABLE IF NOT EXISTS products (
            id BIGINT PRIMARY KEY AUTO_INCREMENT,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            category_id INT,
            rod_length VARCHAR(100),
            line_weight VARCHAR(100),
            cast_weight VARCHAR(100),
            action VARCHAR(100),
            material VARCHAR(100),
            power VARCHAR(100),
            reel_size VARCHAR(100),
            price DOUBLE,
            image_url VARCHAR(1024)
          );

          CREATE TABLE IF NOT EXISTS orders (
            id BIGINT PRIMARY KEY AUTO_INCREMENT,
            user_id BIGINT NOT NULL,
            total_amount DECIMAL(15, 2) NOT NULL,
            shipping_address TEXT NOT NULL,
            payment_method VARCHAR(100) NOT NULL,
            status VARCHAR(50) NOT NULL,
            order_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
          );

          CREATE TABLE IF NOT EXISTS order_items (
            id BIGINT PRIMARY KEY AUTO_INCREMENT,
            order_id BIGINT,
            product_id BIGINT,
            quantity INT,
            price_at_order DOUBLE
          );

          CREATE TABLE IF NOT EXISTS refresh_tokens (
            id BIGINT PRIMARY KEY AUTO_INCREMENT,
            user_id BIGINT,
            token VARCHAR(1024),
            revoked BOOLEAN DEFAULT FALSE,
            expires_at DATETIME
          );
          SQL

          mysql -h 127.0.0.1 -uroot -proot test_db < schema.sql

      - name: Verify test DB tables
        run: |
          echo "Listing tables in test_db:";
          mysql -h 127.0.0.1 -uroot -proot -e "SHOW TABLES IN test_db;"

      - name: Prepare SQLx (generate offline data)
        run: |
          # Install sqlx-cli to prepare query cache (no default features)
          cargo install sqlx-cli --no-default-features --features mysql
          cargo sqlx prepare --merged
          
      - name: Upload sqlx-data.json (for offline mode in future builds)
        uses: actions/upload-artifact@v4
        with:
          name: sqlx-data
          path: sqlx-data.json

      - name: Format check
        run: cargo fmt -- --check

      - name: Lint (clippy)
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run unit tests
        run: cargo test --all --release

  api-tests:
    name: API E2E (PowerShell)
    needs: build
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=5s
          --health-timeout=2s
          --health-retries=10

    env:
      DATABASE_URL: mysql://root:root@127.0.0.1:3306/test_db
      MIDTRANS_SERVER_KEY: ${{ secrets.MIDTRANS_SERVER_KEY }}
      MIDTRANS_CLIENT_KEY: ${{ secrets.MIDTRANS_CLIENT_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Install MySQL client
        run: |
          sudo apt-get update && sudo apt-get install -y default-mysql-client

      - name: Wait for MySQL to be ready
        run: |
          for i in $(seq 1 30); do
            if mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1" >/dev/null 2>&1; then
              echo "MySQL is ready"; break
            fi
            echo "Waiting for MySQL..."; sleep 2
          done

      - name: (Optional) Run DB migrations
        run: |
          # Uncomment if you have sqlx migrations and sqlx-cli installed
          # cargo install sqlx-cli --no-default-features --features mysql
          # sqlx database create
          # sqlx migrate run

      - name: Start server (background)
        run: |
          nohup cargo run > /tmp/server.log 2>&1 &
          sleep 6

      - name: Wait for server to respond
        run: |
          ready=false
          for i in $(seq 1 30); do
            if curl -sS --max-time 2 http://127.0.0.1:3001 >/dev/null 2>&1; then
              ready=true; break
            fi
            sleep 2
          done
          if [ "$ready" != "true" ]; then
            echo "Server not responding on port 3001"; cat /tmp/server.log; exit 1
          fi

      - name: Run API tests (PowerShell)
        shell: pwsh
        env:
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          pwsh -NoProfile -NonInteractive -ExecutionPolicy Bypass -File ./scripts/run_api_tests.ps1 -BaseUrl 'http://127.0.0.1:3001' -AdminEmail $env:ADMIN_EMAIL -AdminPassword $env:ADMIN_PASSWORD

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-logs
          path: ./tmp/api_test_results || .  # adjust if you save logs